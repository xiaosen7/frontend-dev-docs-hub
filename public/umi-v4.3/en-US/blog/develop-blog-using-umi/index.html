<!DOCTYPE html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta property="og:image" content="https://umijs.org/images/og-home.png">
<meta property="og:url" content="https://umijs.org/">
<meta property="og:type" content="article">
<meta property="og:site_name" content="Umi">
<meta property="og:description" content="Umi是可扩展的企业级前端应用框架。Umi 以路由为基础的，同时支持配置式路由和约定式路由，保证路由的功能完备，并以此进行功能扩展。然后配以生命周期完善的插件体系，覆盖从源码到构建产物的每个生命周期，支持各种功能扩展和业务需求。">
<meta property="twitter:image" content="https://umijs.org/images/og-home.png">
<meta property="twitter:site" content="https://umijs.org/">
<meta property="twitter:creator" content="Umi">
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:title" content="Umi">
<meta property="twitter:description" content="Umi是可扩展的企业级前端应用框架。Umi 以路由为基础的，同时支持配置式路由和约定式路由，保证路由的功能完备，并以此进行功能扩展。然后配以生命周期完善的插件体系，覆盖从源码到构建产物的每个生命周期，支持各种功能扩展和业务需求。">
<meta property="fb:app_id" content="922985738798968">
<link rel="shortcut icon" href="https://img.alicdn.com/tfs/TB1YHEpwUT1gK0jSZFhXXaAtVXa-28-27.svg">
<link rel="stylesheet" href="/umi.c9f82ed3.css">
<title data-rh="true">使用 Umi 开发一个 Blog</title>
<meta data-rh="true" property="og:title" content="使用 Umi 开发一个 Blog"/><meta data-rh="true" name="description" content="这篇文章将带领你使用 Umi.js 搭配 PlanetScale, Prisma 和 Tailwindcss等服务与技术，开发一个简单的博客网站，并部署到 Vercel 服务。"/><meta data-rh="true" property="og:description" content="这篇文章将带领你使用 Umi.js 搭配 PlanetScale, Prisma 和 Tailwindcss等服务与技术，开发一个简单的博客网站，并部署到 Vercel 服务。"/>
<link data-rh="true" rel="canonical" href="https://umijs.org//en-US/blog/develop-blog-using-umi"/>
</head>
<body>
<noscript><b>Enable JavaScript to run this app.</b></noscript><div id="root"><!--$?--><template id="B:0"></template><div></div><!--/$--></div><script>window.__UMI_LOADER_DATA__ = {}</script>
<script async="" src="/umi.0bdf4102.js"></script>

</body></html><div hidden id="S:0"><!--$?--><template id="B:1"></template><div></div><!--/$--></div><script>function $RC(a,b){a=document.getElementById(a);b=document.getElementById(b);b.parentNode.removeChild(b);if(a){a=a.previousSibling;var f=a.parentNode,c=a.nextSibling,e=0;do{if(c&&8===c.nodeType){var d=c.data;if("/$"===d)if(0===e)break;else e--;else"$"!==d&&"$?"!==d&&"$!"!==d||e++}d=c.nextSibling;f.removeChild(c);c=d}while(c);for(;b.firstChild;)f.insertBefore(b.firstChild,c);a.data="$";a._reactRetry&&a._reactRetry()}};$RC("B:0","S:0")</script><div hidden id="S:1"><div class="dumi-default-doc-layout"><div class="dumi-default-header"><div class="dumi-default-header-content"><section class="dumi-default-header-left"><a class="dumi-default-logo" href="/en-US"><img src="https://gw.alipayobjects.com/zos/bmw-prod/598d14af-4f1c-497d-b579-5ac42cd4dd1f/k7bjua9c_w132_h130.png" alt="UmiJS"/>UmiJS<!-- --></a></section><section class="dumi-default-header-right"><ul class="dumi-default-navbar"><li><a href="/en-US/docs/introduce/introduce">Introduce</a></li><li><a href="/en-US/docs/guides/getting-started">Guide</a></li><li><a href="/en-US/docs/api/api">API</a></li><li><a href="/en-US/docs/max/introduce">Umi Max</a></li><li><a class="active" href="/en-US/blog/umi-4-rc">Blog</a></li></ul><div class="dumi-default-header-right-aside"><div class="dumi-default-search-bar"><svg viewBox="64 64 896 896" class="dumi-default-search-bar-svg"><path d="M909.6 854.5 649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg><input class="dumi-default-search-bar-input" placeholder="Type keywords..."/><span class="dumi-default-search-shortcut">⌘<!-- --> K<!-- --></span></div><a class="dumi-default-lang-switch" href="/blog/develop-blog-using-umi">中文</a><span class="dumi-default-color-switch" data-dumi-tooltip="Light Mode" data-dumi-tooltip-bottom="true"><svg viewBox="0 0 16 16"><path d="M8 13a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1ZM8 3a1 1 0 0 1-1-1V1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1Zm7 4a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1ZM3 8a1 1 0 0 1-1 1H1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1Zm9.95 3.536.707.707a1 1 0 0 1-1.414 1.414l-.707-.707a1 1 0 0 1 1.414-1.414Zm-9.9-7.072-.707-.707a1 1 0 0 1 1.414-1.414l.707.707A1 1 0 0 1 3.05 4.464Zm9.9 0a1 1 0 0 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 1.414l-.707.707Zm-9.9 7.072a1 1 0 0 1 1.414 1.414l-.707.707a1 1 0 0 1-1.414-1.414l.707-.707ZM8 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm0 6.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"></path></svg><select><option value="light" selected="">Light Mode<!-- --></option><option value="dark">Dark Mode<!-- --></option><option value="auto">Follow System<!-- --></option></select></span><a class="dumi-default-icon" data-dumi-tooltip="GitHub" data-dumi-tooltip-bottom="true" target="_blank" href="https://github.com/umijs/umi" rel="noreferrer"><svg viewBox="64 64 896 896"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a><div class="dumi-default-lang-select" style="border-inline-start:1px solid #d0d5d8;margin-inline-start:15px;padding-inline-start:5px"><select style="padding-top:1px;padding-bottom:1px"><option value="4.3.31" selected="">4.3.31<!-- --></option><option value="3.x">3.x<!-- --></option></select><svg viewBox="64 64 896 896"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></div></div></section><button type="button" class="dumi-default-header-menu-btn"><svg viewBox="64 64 896 896"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></button></div></div><div class="dumi-default-doc-layout-mobile-bar"><button type="button" class="dumi-default-sidebar-btn"><svg viewBox="64 64 896 896"><path d="M120 230h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm0 424h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm784 140H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0-424H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"></path></svg>Sidebar<!-- --></button></div><main><div class="dumi-default-sidebar"><dl class="dumi-default-sidebar-group"><dt>Blog</dt><dd><a title="使用 Umi 开发一个 Blog" aria-current="page" class="active" href="/en-US/blog/develop-blog-using-umi">使用 Umi 开发一个 Blog</a></dd><dd><a title="Umi 4 RC 发布" class="" href="/en-US/blog/umi-4-rc">Umi 4 RC 发布</a></dd><dd><a title="比 Vite 还快的 MFSU" class="" href="/en-US/blog/mfsu-faster-than-vite">比 Vite 还快的 MFSU</a></dd><dd><a title="独立使用 MFSU" class="" href="/en-US/blog/mfsu-independent-usage">独立使用 MFSU</a></dd><dd><a title="代码拆分指南" class="" href="/en-US/blog/code-splitting">代码拆分指南</a></dd><dd><a title="非现代浏览器兼容" class="" href="/en-US/blog/legacy-browser">非现代浏览器兼容</a></dd><dd><a title="物理构建缓存" class="" href="/en-US/blog/webpack-5-prod-cache">物理构建缓存</a></dd></dl></div><div class="dumi-default-content"><article><!--$?--><template id="B:2"></template><div></div><!--/$--></article><footer class="dumi-default-content-footer"><dl><dd><svg viewBox="64 64 896 896"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M686.7 638.6 544.1 535.5V288c0-4.4-3.6-8-8-8H488c-4.4 0-8 3.6-8 8v275.4c0 2.6 1.2 5 3.3 6.5l165.4 120.6c3.6 2.6 8.6 1.8 11.2-1.7l28.6-39c2.6-3.7 1.8-8.7-1.8-11.2z"></path></svg>Last updated: <!-- --><time dateTime=""></time></dd></dl><nav></nav></footer><div class="dumi-default-footer">Open-source MIT Licensed | Copyright © 2017-present</div></div><div class="dumi-default-doc-layout-toc-wrapper"><h4>TABLE OF CONTENTS</h4></div></main></div></div><script>$RC("B:1","S:1")</script><div hidden id="S:2"><div class="markdown"><h1 id="使用-umi-开发一个-blog"><a aria-hidden="true" tabindex="-1" href="#使用-umi-开发一个-blog"><span class="icon icon-link"></span></a>使用 Umi 开发一个 Blog<!-- --></h1><p>这篇文章将带领你使用 Umi.js 搭配 <!-- --><a href="https://planetscale.com/">PlanetScale</a>, <!-- --><a href="https://www.prisma.io/">Prisma</a> 和 <!-- --><a href="https://tailwindcss.com/">Tailwindcss</a>等服务与技术，开发一个简单的博客网站，并部署到 <!-- --><a href="https://vercel.com">Vercel</a> 服务。<!-- --></p><h2 id="成果展示"><a aria-hidden="true" tabindex="-1" href="#成果展示"><span class="icon icon-link"></span></a>成果展示<!-- --></h2><p>成果看起来是这样的：你会有一个博客首页展示你的文章 <!-- --><a href="https://umi-blog-example.vercel.app/">https://umi-blog-example.vercel.app/</a></p><p><img src="https://img.alicdn.com/imgextra/i2/O1CN01a9YcgY24tEdndfXsw_!!6000000007448-2-tps-3104-1974.png" alt="博客首页"/></p><p>点击某一篇文章可以看到这篇文章的完整内容：<!-- --><a href="https://umi-blog-example.vercel.app/posts/5">https://umi-blog-example.vercel.app/posts/5</a></p><p><img src="https://img.alicdn.com/imgextra/i4/O1CN01k84YL21wHCpYx02Yc_!!6000000006282-2-tps-3104-1974.png" alt="博客文章页"/></p><p>当然，你还可以在博客中发表新文章：<!-- --><a href="https://umi-blog-example.vercel.app/posts/create">https://umi-blog-example.vercel.app/posts/create</a></p><p><img src="https://img.alicdn.com/imgextra/i4/O1CN01DZkDt41jvt0BJMZqi_!!6000000004611-2-tps-3104-1974.png" alt="发表文章页"/></p><p>前提是你有登入：<!-- --><a href="https://umi-blog-example.vercel.app/login">https://umi-blog-example.vercel.app/login</a></p><p><img src="https://img.alicdn.com/imgextra/i1/O1CN015ce0oY1uKkfMCa1vq_!!6000000006019-2-tps-3104-1974.png" alt="博客登入页"/></p><p>准备好了吗，让我们马上开始吧！</p><h2 id="环境准备"><a aria-hidden="true" tabindex="-1" href="#环境准备"><span class="icon icon-link"></span></a>环境准备<!-- --></h2><p>首先，你必须确保你的本地环境已经准备好进行一个 Umi.js 项目的开发。如果你目前还没有开发过 Umi.js 项目，也没有在本地搭建过开发环境，建议你先阅读 <!-- --><a href="/en-US/docs/guides/prepare">开发环境</a> 这篇教学。<!-- --></p><p>配置完本地环境以后，你已经准备好开始开发 Umi.js 项目了！跟着 <!-- --><a href="/en-US/docs/guides/boilerplate">脚手架</a> 这篇文档的教学，快速初始化一个 Umi.js 项目吧。<!-- --></p><h3 id="调整目录结构"><a aria-hidden="true" tabindex="-1" href="#调整目录结构"><span class="icon icon-link"></span></a>调整目录结构<!-- --></h3><p>因为我们的博客网站会使用到 Umi 4 的 API 路由功能，所以我们需要对脚手架自动产生的目录结构进行一些调整。你现在的目录结构应该看起来是这样的：</p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-text"><div class=""><div class=""><span class="token plain">.</span></div></div><div class=""><div class=""><span class="token plain">├── assets</span></div></div><div class=""><div class=""><span class="token plain">│    └── yay.jpg</span></div></div><div class=""><div class=""><span class="token plain">├── layouts</span></div></div><div class=""><div class=""><span class="token plain">│    ├── index.less</span></div></div><div class=""><div class=""><span class="token plain">│    └── index.tsx</span></div></div><div class=""><div class=""><span class="token plain">├── node_modules</span></div></div><div class=""><div class=""><span class="token plain">├── package.json</span></div></div><div class=""><div class=""><span class="token plain">├── pages</span></div></div><div class=""><div class=""><span class="token plain">│    ├── docs.tsx</span></div></div><div class=""><div class=""><span class="token plain">│    └── index.tsx</span></div></div><div class=""><div class=""><span class="token plain">├── pnpm-lock.yaml</span></div></div><div class=""><div class=""><span class="token plain">├── tsconfig.json</span></div></div><div class=""><div class=""><span class="token plain">└── typings.d.ts</span></div></div></pre></div><p>我们需要把 <!-- --><code>assets</code>, <!-- --><code>layouts</code>, <!-- --><code>pages</code> 目录从根目录移动到 <!-- --><code>src</code> 目录下，移动之后他看起来是这样的：<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-text"><div class=""><div class=""><span class="token plain">.</span></div></div><div class=""><div class=""><span class="token plain">├── src</span></div></div><div class=""><div class=""><span class="token plain">│   ├── assets</span></div></div><div class=""><div class=""><span class="token plain">│   │    └── yay.jpg</span></div></div><div class=""><div class=""><span class="token plain">│   ├── layouts</span></div></div><div class=""><div class=""><span class="token plain">│   │    ├── index.less</span></div></div><div class=""><div class=""><span class="token plain">│   │    └── index.tsx</span></div></div><div class=""><div class=""><span class="token plain">│   └──── pages</span></div></div><div class=""><div class=""><span class="token plain">│        ├── docs.tsx</span></div></div><div class=""><div class=""><span class="token plain">│        └── index.tsx</span></div></div><div class=""><div class=""><span class="token plain">├── node_modules</span></div></div><div class=""><div class=""><span class="token plain">├── package.json</span></div></div><div class=""><div class=""><span class="token plain">├── pnpm-lock.yaml</span></div></div><div class=""><div class=""><span class="token plain">├── tsconfig.json</span></div></div><div class=""><div class=""><span class="token plain">└── typings.d.ts</span></div></div></pre></div></div><div class="dumi-default-container markdown" data-type="info"><svg viewBox="64 64 896 896"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M464 336a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm72 112h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V456c0-4.4-3.6-8-8-8z"></path></svg><h4>INFO</h4><section><p>为什么要这样做呢？这是因为根目录下的 <!-- --><code>api</code> 目录会被我们作为 API 路由生成构建产物的地方，如果我们没有多一层 <!-- --><code>src</code> 目录的话，我们的 API 路由目录就会和构建产物目录冲突啦～<!-- --></p></section></div><div class="markdown"><h3 id="注册-planetscale-服务"><a aria-hidden="true" tabindex="-1" href="#注册-planetscale-服务"><span class="icon icon-link"></span></a>注册 PlanetScale 服务<!-- --></h3><p>我们的博  客将会把用户和文章的数据保存在 MySQL 数据库中。然而，我们不需要真的自己准备一台服务器来运行数据库，我们可以使用免费的 <!-- --><a href="https://planetscale.com/">PlanetScale</a>来一键部署一个开箱即用的数据库！<!-- --></p><p>首先从 <!-- --><a href="https://auth.planetscale.com/sign-in">https://auth.planetscale.com/sign-in</a>登入你的账号，如果你没有注册过，可以选择使用 GitHub 一键登入或是点击 <!-- --><a href="https://auth.planetscale.com/sign-up">Sign up for an account</a> 注册一个账号。<!-- --></p><p><img src="https://img.alicdn.com/imgextra/i4/O1CN01BVVAju1eONxEM9wr5_!!6000000003861-2-tps-2506-1464.png" alt="登入 PlanetScale"/></p><p>登入之后，在你的 PlanetScale 账号建立一个数据库（如果你是第一次注册，则可以看到他的教学步骤带领你一步步建立一个数据库）：</p><p><img src="https://img.alicdn.com/imgextra/i4/O1CN01St4IQW21lV6f8bpKg_!!6000000007025-2-tps-3104-1974.png" alt="建立数据库"/></p><p>建立完成后，点击数据库页面右上角的 <!-- --><strong>Connect</strong> 按钮：<!-- --></p><p><img src="https://img.alicdn.com/imgextra/i4/O1CN01Hnyqbo26g4UNnSqoQ_!!6000000007690-2-tps-3104-1974.png" alt="Connect 按钮"/></p><p>你会在弹窗里面看到一个 <!-- --><strong>Connect With</strong> 的下拉选单，选择 <!-- --><code>Prisma</code>，然后就能获得一串这个格式的字符串：<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-dotenv"><div class=""><div class=""><span class="token plain">DATABASE_URL=&#x27;mysql://************:************@************.ap-southeast-2.psdb.cloud/umi-blog-example?sslaccept=strict&#x27;</span></div></div></pre></div><p>这个字符串就是我们要用来让 Prisma 连接数据库的连线信息，暂时先把他记录起来就可以了 👍</p><h3 id="安装依赖"><a aria-hidden="true" tabindex="-1" href="#安装依赖"><span class="icon icon-link"></span></a>安装依赖<!-- --></h3><p>接下来，帮我们的 Umi 项目安装这次教程会用到的依赖：</p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-shell"><div class=""><div class=""><span class="token function">pnpm</span><span class="token plain"> i -d prisma @types/bcryptjs @types/jsonwebtoken</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token function">pnpm</span><span class="token plain"> i @prisma/client bcryptjs jsonwebtoken</span></div></div></pre></div><p>这两行命令帮我们安装了这些包：</p><ol><li><a href="https://github.com/prisma/prisma">prisma</a>和 <!-- --><a href="https://www.npmjs.com/package/@prisma/client">@prisma/client</a>:这两个包让我们可以用 <!-- --><a href="https://www.prisma.io/">Prisma</a>来方便地串接数据库，不需要担心任何复杂的 SQL 命令。<!-- --></li><li><a href="https://github.com/dcodeIO/bcrypt.js">bcryptjs</a>:这个包让我们将用户注册后的密码使用 <!-- --><a href="https://en.wikipedia.org/wiki/Bcrypt">Bcrypt</a>哈希加密算法来安全的存储在数据库中。<!-- --></li><li><a href="https://github.com/auth0/node-jsonwebtoken">jsonwebtoken</a>:这个包让我们可以方便地使用用 <!-- --><a href="https://jwt.io/">JWT(Json Web Token)</a> 实现用户鉴权。<!-- --></li></ol><p>然后将 <!-- --><code>package.json</code> 中 <!-- --><code>scripts</code> 里面的 <!-- --><code>build</code> 脚本从<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-undefined"><div class=""><div class=""><span class="token plain">&quot;scripts&quot;: {</span></div></div><div class=""><div class=""><span class="token plain">  &quot;dev&quot;: &quot;umi dev&quot;,</span></div></div><div class=""><div class=""><span class="token plain">  &quot;build&quot;: &quot;umi build&quot;,</span></div></div><div class=""><div class=""><span class="token plain">  &quot;postinstall&quot;: &quot;umi setup&quot;,</span></div></div><div class=""><div class=""><span class="token plain">  &quot;start&quot;: &quot;npm run dev&quot;</span></div></div><div class=""><div class=""><span class="token plain">},</span></div></div></pre></div><p>改成</p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-undefined"><div class=""><div class=""><span class="token plain">&quot;scripts&quot;: {</span></div></div><div class=""><div class=""><span class="token plain">  &quot;dev&quot;: &quot;umi dev&quot;,</span></div></div><div class=""><div class=""><span class="token plain">  &quot;build&quot;: &quot;prisma generate &amp;&amp; umi build&quot;,</span></div></div><div class=""><div class=""><span class="token plain">  &quot;postinstall&quot;: &quot;umi setup&quot;,</span></div></div><div class=""><div class=""><span class="token plain">  &quot;start&quot;: &quot;npm run dev&quot;</span></div></div><div class=""><div class=""><span class="token plain">},</span></div></div></pre></div><p>这可以确保每次开始构建以前都已经生成好 Prisma 客户端。</p><h3 id="安装-tailwindcss"><a aria-hidden="true" tabindex="-1" href="#安装-tailwindcss"><span class="icon icon-link"></span></a>安装 Tailwindcss<!-- --></h3><p>使用 Umi 提供的微生成器来在项目中启用 Tailwindcss :</p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-shell"><div class=""><div class=""><span class="token plain">npx umi g tailwindcss</span></div></div></pre></div><p>他会帮我们安装 Tailwindcss 所需要的依赖，然后生成需要的文件。</p><h3 id="初始化页面组件"><a aria-hidden="true" tabindex="-1" href="#初始化页面组件"><span class="icon icon-link"></span></a>初始化页面组件<!-- --></h3><p>接下来，当你使用 <!-- --><code>pnpm dev</code>启动项目后，可能会看到错误讯息并且启动失败了。这是因为我们在配置中声明了一些页面，但并没有帮他建立对应的页面组件！<!-- --></p><p>我们可以使用 Umi 的微生成器来自动生成这些页面：<!-- --><code>login.tsx</code>, <!-- --><code>posts/post.tsx</code>, <!-- --><code>posts/create.tsx</code>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-shell"><div class=""><div class=""><span class="token plain">npx umi g page login posts/post posts/create</span></div></div></pre></div><p>新增后的目录结构是这样的：</p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-text"><div class=""><div class=""><span class="token plain">src</span></div></div><div class=""><div class=""><span class="token plain">├── assets</span></div></div><div class=""><div class=""><span class="token plain">│     └── yay.jpg</span></div></div><div class=""><div class=""><span class="token plain">├── layouts</span></div></div><div class=""><div class=""><span class="token plain">│     ├── index.less</span></div></div><div class=""><div class=""><span class="token plain">│     └── index.tsx</span></div></div><div class=""><div class=""><span class="token plain">└── pages</span></div></div><div class=""><div class=""><span class="token plain">    ├── index.less</span></div></div><div class=""><div class=""><span class="token plain">    ├── index.tsx</span></div></div><div class=""><div class=""><span class="token plain">    ├── login.less</span></div></div><div class=""><div class=""><span class="token plain">    ├── login.tsx</span></div></div><div class=""><div class=""><span class="token plain">    └── posts</span></div></div><div class=""><div class=""><span class="token plain">        ├── create.less</span></div></div><div class=""><div class=""><span class="token plain">        ├── create.tsx</span></div></div><div class=""><div class=""><span class="token plain">        ├── post.less</span></div></div><div class=""><div class=""><span class="token plain">        └── post.tsx</span></div></div></pre></div><p>现在再输入一次 <!-- --><code>pnpm dev</code> 就可以看到我们的网站正常启动了。<!-- --></p><h3 id="配置-umi-项目"><a aria-hidden="true" tabindex="-1" href="#配置-umi-项目"><span class="icon icon-link"></span></a>配置 umi 项目<!-- --></h3><p>最后一步，就是要来对 Umi 项目进行配置，完整的配置可以参考 <!-- --><a href="/en-US/docs/api/config">配置</a> 这篇教学文档，在本次的教学中，只要按照以下配置即可：<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-ts"><div class=""><div class=""><span class="token comment">// .umirc.ts</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">default</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  npmClient</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;pnpm&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  apiRoute</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    platform</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;vercel&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  routes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> path</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">,</span><span class="token plain"> component</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;index&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> path</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;/posts/create&#x27;</span><span class="token punctuation">,</span><span class="token plain"> component</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;posts/create&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> path</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;/login&#x27;</span><span class="token punctuation">,</span><span class="token plain"> component</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;login&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"> path</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;/posts/:postId&#x27;</span><span class="token punctuation">,</span><span class="token plain"> component</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;posts/post&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  plugins</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token keyword">require</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&#x27;@umijs/plugins/dist/tailwindcss&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  tailwindcss</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><p>其中，<!-- --><code>apiRoute</code> 这个配置项告诉 Umi 我们的项目启用了 <!-- --><strong>API 路由</strong> 这个功能，而 <!-- --><code>platform: &#x27;vercel&#x27;</code> 代表我们要部署到<!-- --><a href="https://vercel.com">Vercel</a> 平台  ，在 <!-- --><code>umi build</code> 的时候会针对这个平台来将 API 路由进行打包。<!-- --></p><p>为了顺利部署项目到 Vercel ，你需要在项目根目录下加入一个 <!-- --><code>vercel.json</code> 配置文件：<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-json"><div class=""><div class=""><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token property">&quot;build&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token property">&quot;env&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token property">&quot;ENABLE_FILE_SYSTEM_API&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;1&quot;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token property">&quot;rewrites&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token property">&quot;source&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;/api/:match*&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token property">&quot;destination&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&quot;api/:match*&quot;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">]</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p><code>route</code> 这个配置项则声明了我们网站的路由架构，可以看到我们的博客网站有这些页面：<!-- --></p><ul><li><code>/</code>: 首页<!-- --></li><li><code>/posts/create</code>: 建立文章<!-- --></li><li><code>/login</code>: 登入<!-- --></li><li><code>/posts/:postId</code>: 某篇文章<!-- --></li></ul><p><code>plugins</code> 配置项代表我们启用了哪些 Umi 插件，其中 <!-- --><code>@umijs/plugins/dist/tailwindcss</code> 是在 Umi 中使用 Tailwindcss
的插件。下面一项 <!-- --><code>tailwindcss: {}</code> 则是从配置来启用该插件的意思。<!-- --></p><h2 id="api-路由设计"><a aria-hidden="true" tabindex="-1" href="#api-路由设计"><span class="icon icon-link"></span></a>API 路由设计<!-- --></h2><p>我们的整个博客网站由两大部分构成，一半是运行在浏览器内的前端代码，另一半则是运行在 Serverless Function 中的服务端代码。</p><p>为什么需要分成两边呢？这是因为有些代码我们不能让他在浏览器内运行，比如说用户鉴权、串接数据库等等的功能，这些必须作为一个服务然后以 API 的形式暴露给前端页面调用，这个部分可以透过 Umi 4 的 API 路由功能来实现。</p><blockquote><p>(这里好像放一张图可以比较清楚地解释)</p></blockquote><p>因为我们已经在 <!-- --><code>.umirc.ts</code> 配置文件中声明了我们要启用 API 路由功能，现在可以直接在 <!-- --><code>src</code> 目录下添加一个 <!-- --><code>api</code>目录，这个目录下以约定式路由的设计来提供 API 路由的开发。<!-- --></p><p>作为一个博客的 API 服务，不难想到我们会需要这些接口来供用户调用：</p><ol><li>用户注册: <!-- --><code>POST /api/register</code></li><li>用户登入: <!-- --><code>POST /api/login</code></li><li>发表文章: <!-- --><code>POST /api/posts</code></li><li>查询所有文章: <!-- --><code>GET /api/posts</code></li><li>查询一篇文章: <!-- --><code>GET /api/posts/{postId}</code></li></ol><p>所以我们可以在 <!-- --><code>src/api</code> 目录下建立这些新文件：<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-text"><div class=""><div class=""><span class="token plain">src</span></div></div><div class=""><div class=""><span class="token plain">├── api</span></div></div><div class=""><div class=""><span class="token plain">│     ├── login.ts</span></div></div><div class=""><div class=""><span class="token plain">│     ├── register.ts</span></div></div><div class=""><div class=""><span class="token plain">│     └── posts</span></div></div><div class=""><div class=""><span class="token plain">│           ├── [postId].ts</span></div></div><div class=""><div class=""><span class="token plain">│           └── index.ts</span></div></div><div class=""><div class=""><span class="token plain">...</span></div></div></pre></div></div><div class="dumi-default-container markdown" data-type="info"><svg viewBox="64 64 896 896"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M464 336a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm72 112h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V456c0-4.4-3.6-8-8-8z"></path></svg><h4>INFO</h4><section><p>你可能注意到了，这里有一个文件叫做 <!-- --><code>[postId].ts</code>，这个写法代表这个路由可以动态匹配不同的值。例如 <!-- --><code>/api/posts/1</code> 和 <!-- --><code>/api/posts/2</code> 两个请求都会交给 <!-- --><code>src/api/posts/[postId].ts</code>处理，但他们的 <!-- --><code>req.params</code> 分别是 <!-- --><code>{ postId: 1 }</code> 和 <!-- --><code>{ postId: 2 }</code>。<!-- --></p></section></div><div class="markdown"><p>这里的每个 <!-- --><code>.ts</code> 文件就是一个 <!-- --><strong>API Handler</strong>，他们默认导出一个函数用来处理发送到该路径的请求，我们可以暂时先这样写：<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-ts"><div class=""><div class=""><span class="token keyword">import</span><span class="token plain"> </span><span class="token keyword">type</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> UmiApiRequest</span><span class="token punctuation">,</span><span class="token plain"> UmiApiResponse </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;umi&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">default</span><span class="token plain"> </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">req</span><span class="token operator">:</span><span class="token plain"> UmiApiRequest</span><span class="token punctuation">,</span><span class="token plain"> res</span><span class="token operator">:</span><span class="token plain"> UmiApiResponse</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  res</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> error</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;This API is not implemented yet.&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>然后你可以试着用浏览器或 <!-- --><a href="https://www.postman.com">Postman</a> 访问看看这些 API 路由（例如 <!-- --><code>http://localhost:8000/api/login</code> )，就可以看到你刚刚写的响应数据了 🎉<!-- --></p><p><img src="https://img.alicdn.com/imgextra/i3/O1CN01IRTlsd1HXmvCRJUt1_!!6000000000768-2-tps-1302-666.png" alt="Not implemented yet"/></p><p>我们等一下再回来实作这些 API 路由的实际功能，因为有一个更重要的事情要先做。</p><h2 id="定义-schema"><a aria-hidden="true" tabindex="-1" href="#定义-schema"><span class="icon icon-link"></span></a>定义 Schema<!-- --></h2><p>现在必须要先确定一件事情：我们要保存哪些数据、以怎么样的形式保存在数据库，又是以怎么样的形式响应给前端的？</p><h3 id="文章数据"><a aria-hidden="true" tabindex="-1" href="#文章数据"><span class="icon icon-link"></span></a>文章数据<!-- --></h3><p>文章数据（Post）每笔数据就代表了一篇博客里面的文章，我们可以按自己的系统需求来设计他需要保存的内容，例如我们的范例保存了这些数据：</p><ul><li><code>id</code>: 文章 ID<!-- --></li><li><code>title</code>: 文章标题<!-- --></li><li><code>authorId</code>: 作者的 ID<!-- --></li><li><code>tags</code>: 文章的标签（以逗号隔开）<!-- --></li><li><code>imageUrl</code>: 文章封面图片的链接<!-- --></li><li><code>content</code>: 文章的内文（markdown 格式）<!-- --></li></ul><h3 id="用户数据"><a aria-hidden="true" tabindex="-1" href="#用户数据"><span class="icon icon-link"></span></a>用户数据<!-- --></h3><p>用户数据 (User) 每笔数据代表一个在我们博客注册的用户数据，我们可以按照自己的系统需求来设计他需要保存的内容，例如我们的范例保存了这些数据：</p><ul><li><code>id</code>: 用户 ID<!-- --></li><li><code>name</code>: 名称<!-- --></li><li><code>email</code>: 邮箱<!-- --></li><li><code>avatarUrl</code>: 头像链接<!-- --></li><li><code>passwordHash</code>: 加密过的密码<!-- --></li></ul><h3 id="生成配置"><a aria-hidden="true" tabindex="-1" href="#生成配置"><span class="icon icon-link"></span></a>生成配置<!-- --></h3><blockquote><p>这个章节可以考虑阅读 <!-- --><a href="https://www.prisma.io/docs/getting-started/setup-prisma/start-from-scratch/relational-databases-typescript-mysql">Prisma 官方的教学文档</a></p></blockquote><p>定义好数据格式以后，我们要让 Prisma 帮我们根据 Schema 设计来生成对应的客户端，并且自动的将数据库迁移至为我们设计的格式，</p><h4 id="连线到数据库"><a aria-hidden="true" tabindex="-1" href="#连线到数据库"><span class="icon icon-link"></span></a>连线到数据库<!-- --></h4><p>第一步，我们在根目录建立一个 <!-- --><code>.env</code> 文件，并且在里面加入刚刚在 <!-- --><a href="/en-US/blog/develop-blog-using-umi#%E6%B3%A8%E5%86%8C-planetscale-%E6%9C%8D%E5%8A%A1">注册 PlanetScale 服务</a> 章节拿到的连线信息。<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-dotenv"><div class=""><div class=""><span class="token plain"># .env</span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">DATABASE_URL=&#x27;mysql://************:************@************.ap-southeast-2.psdb.cloud/umi-blog-example?sslaccept=strict&#x27;</span></div></div></pre></div><h4 id="编写-prisma-配置"><a aria-hidden="true" tabindex="-1" href="#编写-prisma-配置"><span class="icon icon-link"></span></a>编写 Prisma 配置<!-- --></h4><p>第二步，在根目录下建立一个 <!-- --><code>prisma/schema.prisma</code> 文件，并把我们设计的 Schema 按照 <!-- --><a href="https://pris.ly/d/prisma-schema">Prisma 语法</a> 写进去文件中：<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-prisma"><div class=""><div class=""><span class="token plain">generator client {</span></div></div><div class=""><div class=""><span class="token plain">  provider = &quot;prisma-client-js&quot;</span></div></div><div class=""><div class=""><span class="token plain">  previewFeatures = [&quot;referentialIntegrity&quot;]</span></div></div><div class=""><div class=""><span class="token plain">}</span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">datasource db {</span></div></div><div class=""><div class=""><span class="token plain">  provider = &quot;mysql&quot;</span></div></div><div class=""><div class=""><span class="token plain">  referentialIntegrity = &quot;prisma&quot;</span></div></div><div class=""><div class=""><span class="token plain">  url      = env(&quot;DATABASE_URL&quot;)</span></div></div><div class=""><div class=""><span class="token plain">}</span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">model Post {</span></div></div><div class=""><div class=""><span class="token plain">  id        Int      @id @default(autoincrement())</span></div></div><div class=""><div class=""><span class="token plain">  createdAt DateTime @default(now())</span></div></div><div class=""><div class=""><span class="token plain">  updatedAt DateTime @updatedAt</span></div></div><div class=""><div class=""><span class="token plain">  title     String   @db.VarChar(255)</span></div></div><div class=""><div class=""><span class="token plain">  content   String?</span></div></div><div class=""><div class=""><span class="token plain">  author    User     @relation(fields: [authorId], references: [id])</span></div></div><div class=""><div class=""><span class="token plain">  authorId  Int</span></div></div><div class=""><div class=""><span class="token plain">  imageUrl  String?</span></div></div><div class=""><div class=""><span class="token plain">  tags      String</span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  @@index(authorId)</span></div></div><div class=""><div class=""><span class="token plain">}</span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">model User {</span></div></div><div class=""><div class=""><span class="token plain">  id            Int      @id @default(autoincrement())</span></div></div><div class=""><div class=""><span class="token plain">  email         String   @unique</span></div></div><div class=""><div class=""><span class="token plain">  passwordHash  String</span></div></div><div class=""><div class=""><span class="token plain">  name          String?</span></div></div><div class=""><div class=""><span class="token plain">  posts         Post[]</span></div></div><div class=""><div class=""><span class="token plain">  avatarUrl     String?</span></div></div><div class=""><div class=""><span class="token plain">}</span></div></div></pre></div><p>完成后，在命令行输入</p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-shell"><div class=""><div class=""><span class="token plain">npx prisma migrate dev --name init</span></div></div></pre></div><p>他会帮我们将 MySQL 数据库迁移为我们定义的格式。 接下来，在命令行输入</p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-shell"><div class=""><div class=""><span class="token plain">npx prisma generate</span></div></div></pre></div><p>他会帮我们生成一个按照我们的 Schema 设计量身定制的客户端包。</p><hr/><p>至此，我们已经顺利处理完数据库的部分，接下来只要专注于如何在 API 路由中使用 Prisma 客户端包来获取与更新数据即可。</p><h2 id="实现-api-路由"><a aria-hidden="true" tabindex="-1" href="#实现-api-路由"><span class="icon icon-link"></span></a>实现 API 路由<!-- --></h2><p>我们现在要回头来实现刚刚建立的那些 <!-- --><code>api</code> 目录下的 <!-- --><code>.ts</code> 文件了，只要我们自己清楚：<!-- --></p><ol><li>API 会如何被调用 (path, request header, request body)</li><li>我们应该在 API 内做什么事</li><li>响应什么内容回去 (status, response header, response body)</li></ol><p>那么 API 路由的开发就像写编写一个简单的函数一样。</p><h3 id="用户注册"><a aria-hidden="true" tabindex="-1" href="#用户注册"><span class="icon icon-link"></span></a>用户注册<!-- --></h3><p>当用户对 <!-- --><code>/api/register</code> 发起 <!-- --><code>POST</code> 请求时，代表他们想要在我们的博客网站注册一个账号。<!-- --></p></div><div class="dumi-default-container markdown" data-type="info"><svg viewBox="64 64 896 896"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M464 336a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm72 112h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V456c0-4.4-3.6-8-8-8z"></path></svg><h4>INFO</h4><section><p>你可以在 <!-- --><a href="https://github.com/umijs/umi-blog-example/blob/main/src/api/register.ts">https://github.com/umijs/umi-blog-example/blob/main/src/api/register.ts</a> 找到这个示范的源代码！<!-- --></p></section></div><div class="markdown"><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-ts"><div class=""><div class=""><span class="token comment">// src/api/register.ts</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token keyword">type</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> UmiApiRequest</span><span class="token punctuation">,</span><span class="token plain"> UmiApiResponse </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;umi&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> PrismaClient </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;@prisma/client&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> bcrypt </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;bcryptjs&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> signToken </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;@/utils/jwt&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">default</span><span class="token plain"> </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">req</span><span class="token operator">:</span><span class="token plain"> UmiApiRequest</span><span class="token punctuation">,</span><span class="token plain"> res</span><span class="token operator">:</span><span class="token plain"> UmiApiResponse</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">req</span><span class="token punctuation">.</span><span class="token plain">method</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 如果对这个路径发起 POST 请求，代表他想要注册一个账号</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&#x27;POST&#x27;</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 建立一个 Prisma 客户端，他可以帮助我们连线到数据库</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> prisma </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">PrismaClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 在数据库的 User 表中建立一个新的数据</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> user </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">await</span><span class="token plain"> prisma</span><span class="token punctuation">.</span><span class="token plain">user</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          data</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            email</span><span class="token operator">:</span><span class="token plain"> req</span><span class="token punctuation">.</span><span class="token plain">body</span><span class="token punctuation">.</span><span class="token plain">email</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">            </span><span class="token comment">// 密码是经过 bcrypt 加密的</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            passwordHash</span><span class="token operator">:</span><span class="token plain"> bcrypt</span><span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span><span class="token plain">req</span><span class="token punctuation">.</span><span class="token plain">body</span><span class="token punctuation">.</span><span class="token plain">password</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            name</span><span class="token operator">:</span><span class="token plain"> req</span><span class="token punctuation">.</span><span class="token plain">body</span><span class="token punctuation">.</span><span class="token plain">name</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            avatarUrl</span><span class="token operator">:</span><span class="token plain"> req</span><span class="token punctuation">.</span><span class="token plain">body</span><span class="token punctuation">.</span><span class="token plain">avatarUrl</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 把建立成功的用户数据（不包含密码）和 JWT 回传给前端</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        res</span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">.</span><span class="token function">setCookie</span><span class="token punctuation">(</span><span class="token string">&#x27;token&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">await</span><span class="token plain"> </span><span class="token function">signToken</span><span class="token punctuation">(</span><span class="token plain">user</span><span class="token punctuation">.</span><span class="token plain">id</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token operator">...</span><span class="token plain">user</span><span class="token punctuation">,</span><span class="token plain"> passwordHash</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">undefined</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 处理完请求以后记得断开数据库链接</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">await</span><span class="token plain"> prisma</span><span class="token punctuation">.</span><span class="token function">$disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">e</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 如果发生未预期的错误，将对应的错误说明的 Prisma 文档发给用户</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        res</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          result</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          message</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            </span><span class="token keyword">typeof</span><span class="token plain"> e</span><span class="token punctuation">.</span><span class="token plain">code </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;string&#x27;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">              </span><span class="token operator">?</span><span class="token plain"> </span><span class="token string">&#x27;https://www.prisma.io/docs/reference/api-reference/error-reference#&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">                e</span><span class="token punctuation">.</span><span class="token plain">code</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">              </span><span class="token operator">:</span><span class="token plain"> e</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">default</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 如果不是 POST 请求，代表他正在用错误的方式访问这个 API</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      res</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">405</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> error</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;Method not allowed&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>完成开发后，可以使用 Postman 对这个 API 发起请求，测试功能是否正常运作。</p><h3 id="用户登入"><a aria-hidden="true" tabindex="-1" href="#用户登入"><span class="icon icon-link"></span></a>用户登入<!-- --></h3><p>当用户对 <!-- --><code>/api/login</code> 发起 <!-- --><code>POST</code> 请求时，代表他们想要登入我们的博客网站并取得一个 JWT 令牌，这可以让他用于建立新文章。<!-- --></p></div><div class="dumi-default-container markdown" data-type="info"><svg viewBox="64 64 896 896"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M464 336a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm72 112h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V456c0-4.4-3.6-8-8-8z"></path></svg><h4>INFO</h4><section><p>这个部分留给读者练习，你可以在 <!-- --><a href="https://github.com/umijs/umi-blog-example/blob/main/src/api/login.ts">https://github.com/umijs/umi-blog-example/blob/main/src/api/login.ts</a> 找到这个示范的源代码！<!-- --></p></section></div><div class="markdown"><h3 id="发表文章"><a aria-hidden="true" tabindex="-1" href="#发表文章"><span class="icon icon-link"></span></a>发表文章<!-- --></h3><p>当用户对 <!-- --><code>/api/posts</code> 发起 <!-- --><code>POST</code> 请求时，代表他们想要在我们的博客网站发表一篇文章。<!-- --></p></div><div class="dumi-default-container markdown" data-type="info"><svg viewBox="64 64 896 896"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M464 336a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm72 112h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V456c0-4.4-3.6-8-8-8z"></path></svg><h4>INFO</h4><section><p>这个部分留给读者练习，你可以在 <!-- --><a href="https://github.com/umijs/umi-blog-example/blob/main/src/api/posts/index.ts">https://github.com/umijs/umi-blog-example/blob/main/src/api/posts/index.ts</a> 找到这个示范的源代码！<!-- --></p></section></div><div class="markdown"><h3 id="查询所有文章"><a aria-hidden="true" tabindex="-1" href="#查询所有文章"><span class="icon icon-link"></span></a>查询所有文章<!-- --></h3><p>当用户对 <!-- --><code>/api/posts</code> 发起 <!-- --><code>GET</code> 请求时，代表他们想要查询所有文章的数据。<!-- --></p></div><div class="dumi-default-container markdown" data-type="info"><svg viewBox="64 64 896 896"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M464 336a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm72 112h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V456c0-4.4-3.6-8-8-8z"></path></svg><h4>INFO</h4><section><p>这个部分留给读者练习，你可以在 <!-- --><a href="https://github.com/umijs/umi-blog-example/blob/main/src/api/posts/index.ts">https://github.com/umijs/umi-blog-example/blob/main/src/api/posts/index.ts</a> 找到这个示范的源代码！<!-- --></p></section></div><div class="markdown"><h3 id="查询某篇文章"><a aria-hidden="true" tabindex="-1" href="#查询某篇文章"><span class="icon icon-link"></span></a>查询某篇文章<!-- --></h3><p>当用户对 <!-- --><code>/api/posts/{postId}</code> 发起 <!-- --><code>GET</code> 请求时，代表他们想要查询某篇文章的数据。<!-- --></p></div><div class="dumi-default-container markdown" data-type="info"><svg viewBox="64 64 896 896"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M464 336a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm72 112h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V456c0-4.4-3.6-8-8-8z"></path></svg><h4>INFO</h4><section><p>这个部分留给读者练习，你可以在 <!-- --><a href="https://github.com/umijs/umi-blog-example/blob/main/src/api/posts/%5BpostId%5D.ts">https://github.com/umijs/umi-blog-example/blob/main/src/api/posts/%5BpostId%5D.ts</a> 找到这个示范的源代码！<!-- --></p></section></div><div class="markdown"><h2 id="实作页面组件"><a aria-hidden="true" tabindex="-1" href="#实作页面组件"><span class="icon icon-link"></span></a>实作页面组件<!-- --></h2><p>在这个章节，我们主要要学习如何在页面组件调用 API  ，来实现获取文章或注册等前后端交互的行为：</p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-jsx"><div class=""><div class=""><span class="token comment">// pages/index.tsx</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">React</span><span class="token imports punctuation">,</span><span class="token imports"> </span><span class="token imports punctuation">{</span><span class="token imports"> useEffect</span><span class="token imports punctuation">,</span><span class="token imports"> useState </span><span class="token imports punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;react&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports punctuation">{</span><span class="token imports"> history </span><span class="token imports punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&quot;umi&quot;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">HomePage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">posts</span><span class="token punctuation">,</span><span class="token plain"> setPosts</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> useState</span><span class="token operator">&lt;</span><span class="token plain">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">      </span><span class="token punctuation">{</span><span class="token operator">!</span><span class="token plain">posts </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token tag punctuation">&lt;</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token plain-text">Loading...</span><span class="token tag punctuation">&lt;/</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">}</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">      </span><span class="token punctuation">{</span><span class="token plain">posts </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">        </span><span class="token punctuation">{</span><span class="token plain">posts</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">post</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag"> </span><span class="token tag attr-name">key</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript">post</span><span class="token tag script language-javascript punctuation">.</span><span class="token tag script language-javascript property-access">id</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">          </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag"> </span><span class="token tag attr-name">onClick</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript arrow operator">=&gt;</span><span class="token tag script language-javascript"> history</span><span class="token tag script language-javascript punctuation">.</span><span class="token tag script language-javascript method function property-access">push</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript template-string template-punctuation string">`</span><span class="token tag script language-javascript template-string string">/posts/</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation">${</span><span class="token tag script language-javascript template-string interpolation">post</span><span class="token tag script language-javascript template-string interpolation punctuation">.</span><span class="token tag script language-javascript template-string interpolation property-access">id</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation">}</span><span class="token tag script language-javascript template-string template-punctuation string">`</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">            </span><span class="token tag punctuation">&lt;</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">{</span><span class="token plain">post</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">}</span><span class="token tag punctuation">&lt;/</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">          </span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">        </span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">      </span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">}</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>可以看到我们在首页组件维护了一个 <!-- --><code>posts</code> 状态，当 <!-- --><code>posts</code> 是 <!-- --><code>undefined</code> 时，我们认为是数据尚未加载完成。所以我们可以加入一个 <!-- --><code>useEffect</code>让他在组件加载后对 API 路由发起一个请求，去查询目前所有的文章列表：<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-tsx"><div class=""><div class=""><span class="token comment">// pages/index.tsx</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">React</span><span class="token imports punctuation">,</span><span class="token imports"> </span><span class="token imports punctuation">{</span><span class="token imports"> useEffect</span><span class="token imports punctuation">,</span><span class="token imports"> useState </span><span class="token imports punctuation">}</span><span class="token plain"> </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;react&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">import</span><span class="token plain"> </span><span class="token imports punctuation">{</span><span class="token imports"> history </span><span class="token imports punctuation">}</span><span class="token plain"> </span><span class="token keyword">from</span><span class="token plain"> </span><span class="token string">&#x27;umi&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">default</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">HomePage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">posts</span><span class="token punctuation">,</span><span class="token plain"> setPosts</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token generic-function function">useState</span><span class="token generic-function generic class-name operator">&lt;</span><span class="token generic-function generic class-name builtin">any</span><span class="token generic-function generic class-name punctuation">[</span><span class="token generic-function generic class-name punctuation">]</span><span class="token generic-function generic class-name operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">async</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> res </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">await</span><span class="token plain"> </span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/posts&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">res</span><span class="token punctuation">.</span><span class="token property-access">status</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token number">200</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span><span class="token keyword">await</span><span class="token plain"> res</span><span class="token punctuation">.</span><span class="token method function property-access">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">setPosts</span><span class="token punctuation">(</span><span class="token keyword">await</span><span class="token plain"> res</span><span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span><span class="token plain">err</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">      </span><span class="token punctuation">{</span><span class="token operator">!</span><span class="token plain">posts </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token tag punctuation">&lt;</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token plain-text">Loading...</span><span class="token tag punctuation">&lt;/</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">}</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">      </span><span class="token punctuation">{</span><span class="token plain">posts </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">          </span><span class="token punctuation">{</span><span class="token plain">posts</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">post</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag"> </span><span class="token tag attr-name">key</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript">post</span><span class="token tag script language-javascript punctuation">.</span><span class="token tag script language-javascript property-access">id</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">              </span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag"> </span><span class="token tag attr-name">onClick</span><span class="token tag script language-javascript script-punctuation punctuation">=</span><span class="token tag script language-javascript punctuation">{</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript"> </span><span class="token tag script language-javascript arrow operator">=&gt;</span><span class="token tag script language-javascript"> history</span><span class="token tag script language-javascript punctuation">.</span><span class="token tag script language-javascript method function property-access">push</span><span class="token tag script language-javascript punctuation">(</span><span class="token tag script language-javascript template-string template-punctuation string">`</span><span class="token tag script language-javascript template-string string">/posts/</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation">${</span><span class="token tag script language-javascript template-string interpolation">post</span><span class="token tag script language-javascript template-string interpolation punctuation">.</span><span class="token tag script language-javascript template-string interpolation">id</span><span class="token tag script language-javascript template-string interpolation interpolation-punctuation punctuation">}</span><span class="token tag script language-javascript template-string template-punctuation string">`</span><span class="token tag script language-javascript punctuation">)</span><span class="token tag script language-javascript punctuation">}</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">                </span><span class="token tag punctuation">&lt;</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token punctuation">{</span><span class="token plain">post</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">}</span><span class="token tag punctuation">&lt;/</span><span class="token tag">p</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">              </span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">            </span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">        </span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text"></span></div></div><div class=""><div class=""><span class="token plain-text">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>可以看到我们加入了一个 <!-- --><code>refresh</code> 函数，他会帮我们从 API 路由查询目前的文章列表。若你现在访问这个页面，应该可以看到一开始是 <!-- --><code>Loading ...</code>
等一阵子就会有全部文章的标题被渲染出来的效果。<!-- --></p><p><img src="https://img.alicdn.com/imgextra/i1/O1CN01n3CA371n0PlgkdEvQ_!!6000000005027-2-tps-3104-1974.png" alt="titles"/></p><p>最后只要帮他加一点样式：</p><p><img src="https://img.alicdn.com/imgextra/i1/O1CN01sfpTVd1IGDLK068gY_!!6000000000865-2-tps-3104-1974.png" alt="titles-with-style"/></p><hr/><p>其他页面留给读者实作，可以加入自己的想法及样式的设计来实现，源代码可参考：<!-- --><a href="https://github.com/umijs/umi-blog-example/blob/main/src/pages">https://github.com/umijs/umi-blog-example/blob/main/src/pages</a></p><h2 id="部署"><a aria-hidden="true" tabindex="-1" href="#部署"><span class="icon icon-link"></span></a>部署<!-- --></h2><p>最后，将你的项目提交到 git 服务上，然后登入 <!-- --><a href="https://vercel.com">Vercel</a>:<!-- --></p><p><img src="https://img.alicdn.com/imgextra/i2/O1CN01X7LqFx1LbEMYzLT3k_!!6000000001317-2-tps-2720-1710.png" alt="Vercel"/></p><p>如果你的项目代码是提交到 GitHub，那么建议你选择 GitHub 登入，这样你就可以在 Vercel 直接导入现有的代码仓库了 👍</p><p><img src="https://img.alicdn.com/imgextra/i1/O1CN014qIgle23G171pvX0V_!!6000000007227-2-tps-2720-1818.png" alt="Vercel New Project"/></p><p>导入以后，他会自动检测到这个项目是使用 Umi.js 框架搭建的，并且自动化完成相关的配置，因此直接点击 <!-- --><strong>Deploy</strong> 即可开始部署！<!-- --></p><p><img src="https://img.alicdn.com/imgextra/i3/O1CN013Ts04x1tqyv4VhzbW_!!6000000005954-2-tps-1468-1064.png" alt="Deploy"/>等他部署完成以后，你的博客就正式上线啦 👍<!-- --></p><hr/><p>但这个时候你会发现，网站内的 API 路由没有办法正常工作，这是因为他缺少了连线到数据库需要的环境变量。我们需要帮他配置一下：</p><p><img src="https://img.alicdn.com/imgextra/i1/O1CN01OYPPB61G61IKR8chz_!!6000000000572-2-tps-2632-1934.png" alt="Settings"/></p><p>在项目配置页面，下面有可以设置环境变量的地方：</p><p><img src="https://img.alicdn.com/imgextra/i4/O1CN01nOLflV1I4lRMwsYHk_!!6000000000840-2-tps-2632-1934.png" alt="Env"/></p><p>你可以把 <!-- --><code>DATABASE_URL</code>, <!-- --><code>JWT_KEY</code> 等等你用到的环境变量从这里传入。<!-- --></p><p><img src="https://img.alicdn.com/imgextra/i3/O1CN013dlBGs2506aFTigki_!!6000000007463-2-tps-2644-1890.png" alt="Redeploy"/></p><p>加入环境变量以后，点击 <!-- --><strong>Redeploy</strong> 重新部署一次版本，你的博客就能正常运作啦～<!-- --></p></div></div><script>$RC("B:2","S:2")</script>